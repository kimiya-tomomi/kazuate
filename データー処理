#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‚åŠ è€…ã®ã‚¹ã‚³ã‚¢çµ±è¨ˆã‚’ç®—å‡ºã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ 
å¹³å‡ç‚¹ã€æœ€é«˜ç‚¹ã€æœ€ä½ç‚¹ã‚’è¨ˆç®—ã—ã€åˆ†ã‹ã‚Šã‚„ã™ãè¡¨ç¤ºã—ã¾ã™ã€‚
"""

import csv
import os
import statistics
from typing import List, Dict, Tuple


class ScoreAnalyzer:
    """ã‚¹ã‚³ã‚¢åˆ†æã‚¯ãƒ©ã‚¹"""
    
    def __init__(self, csv_file_path: str):
        """
        åˆæœŸåŒ–
        
        Args:
            csv_file_path (str): CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
        """
        self.csv_file_path = csv_file_path
        self.participants_data = {}
        
    def load_csv_data(self) -> bool:
        """
        CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        
        Returns:
            bool: èª­ã¿è¾¼ã¿æˆåŠŸã®å ´åˆTrueã€å¤±æ•—ã®å ´åˆFalse
        """
        try:
            if not os.path.exists(self.csv_file_path):
                print(f"ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ« '{self.csv_file_path}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
                return False
                
            with open(self.csv_file_path, 'r', encoding='utf-8') as file:
                csv_reader = csv.DictReader(file)
                
                for row in csv_reader:
                    participant_name = row['å‚åŠ è€…å']
                    scores = []
                    
                    # ã‚¹ã‚³ã‚¢åˆ—ã‚’æŠ½å‡ºï¼ˆå‚åŠ è€…åä»¥å¤–ã®åˆ—ï¼‰
                    for key, value in row.items():
                        if key != 'å‚åŠ è€…å':
                            try:
                                score = float(value)
                                scores.append(score)
                            except ValueError:
                                print(f"è­¦å‘Š: {participant_name}ã®{key}ã®å€¤ '{value}' ã¯æ•°å€¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚")
                                
                    if scores:
                        self.participants_data[participant_name] = scores
                        
            print(f"âœ“ {len(self.participants_data)}åã®å‚åŠ è€…ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚")
            return True
            
        except Exception as e:
            print(f"ã‚¨ãƒ©ãƒ¼: CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
            return False
    
    def calculate_statistics(self) -> Dict[str, Dict[str, float]]:
        """
        å„å‚åŠ è€…ã®çµ±è¨ˆã‚’è¨ˆç®—ã™ã‚‹
        
        Returns:
            Dict[str, Dict[str, float]]: å‚åŠ è€…åã‚’ã‚­ãƒ¼ã¨ã—ãŸçµ±è¨ˆãƒ‡ãƒ¼ã‚¿
        """
        statistics_data = {}
        
        for participant, scores in self.participants_data.items():
            if scores:
                stats = {
                    'å¹³å‡ç‚¹': round(statistics.mean(scores), 2),
                    'æœ€é«˜ç‚¹': max(scores),
                    'æœ€ä½ç‚¹': min(scores),
                    'ã‚¹ã‚³ã‚¢æ•°': len(scores),
                    'å…¨ã‚¹ã‚³ã‚¢': scores
                }
                statistics_data[participant] = stats
                
        return statistics_data
    
    def display_results(self, statistics_data: Dict[str, Dict[str, float]]) -> None:
        """
        çµæœã‚’åˆ†ã‹ã‚Šã‚„ã™ãè¡¨ç¤ºã™ã‚‹
        
        Args:
            statistics_data (Dict[str, Dict[str, float]]): çµ±è¨ˆãƒ‡ãƒ¼ã‚¿
        """
        print("\n" + "="*80)
        print("ğŸ“Š å‚åŠ è€…ã‚¹ã‚³ã‚¢çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆ")
        print("="*80)
        
        # å…¨ä½“çµ±è¨ˆ
        all_scores = []
        for stats in statistics_data.values():
            all_scores.extend(stats['å…¨ã‚¹ã‚³ã‚¢'])
            
        if all_scores:
            print(f"\nğŸ“ˆ å…¨ä½“çµ±è¨ˆ:")
            print(f"   å‚åŠ è€…æ•°: {len(statistics_data)}å")
            print(f"   ç·ã‚¹ã‚³ã‚¢æ•°: {len(all_scores)}ç‚¹")
            print(f"   å…¨ä½“å¹³å‡: {round(statistics.mean(all_scores), 2)}ç‚¹")
            print(f"   å…¨ä½“æœ€é«˜ç‚¹: {max(all_scores)}ç‚¹")
            print(f"   å…¨ä½“æœ€ä½ç‚¹: {min(all_scores)}ç‚¹")
        
        print("\n" + "-"*80)
        print("ğŸ‘¥ å€‹äººåˆ¥çµ±è¨ˆ:")
        print("-"*80)
        
        # å€‹äººåˆ¥çµ±è¨ˆã‚’å¹³å‡ç‚¹é †ã§ã‚½ãƒ¼ãƒˆ
        sorted_participants = sorted(
            statistics_data.items(), 
            key=lambda x: x[1]['å¹³å‡ç‚¹'], 
            reverse=True
        )
        
        for rank, (participant, stats) in enumerate(sorted_participants, 1):
            print(f"\nğŸ† ç¬¬{rank}ä½: {participant}")
            print(f"   ï¿½ï¿½ å¹³å‡ç‚¹: {stats['å¹³å‡ç‚¹']}ç‚¹")
            print(f"   ï¿½ï¿½ æœ€é«˜ç‚¹: {stats['æœ€é«˜ç‚¹']}ç‚¹")
            print(f"   ï¿½ï¿½ æœ€ä½ç‚¹: {stats['æœ€ä½ç‚¹']}ç‚¹")
            print(f"   ï¿½ï¿½ ã‚¹ã‚³ã‚¢æ•°: {stats['ã‚¹ã‚³ã‚¢æ•°']}å›")
            print(f"   ğŸ“‹ å…¨ã‚¹ã‚³ã‚¢: {', '.join(map(str, stats['å…¨ã‚¹ã‚³ã‚¢']))}")
            
            # å¹³å‡ç‚¹ã«ã‚ˆã‚‹è©•ä¾¡
            avg_score = stats['å¹³å‡ç‚¹']
            if avg_score >= 90:
                evaluation = "ğŸŒŸ å„ªç§€"
            elif avg_score >= 80:
                evaluation = "ğŸ‘ è‰¯å¥½"
            elif avg_score >= 70:
                evaluation = "ğŸ“ˆ æ™®é€š"
            else:
                evaluation = "ğŸ“š è¦åŠªåŠ›"
            print(f"   ğŸ’­ è©•ä¾¡: {evaluation}")
        
        print("\n" + "="*80)
        print("ğŸ“‹ è©³ç´°ãƒ‡ãƒ¼ã‚¿è¡¨:")
        print("="*80)
        
        # è¡¨å½¢å¼ã§ã®è¡¨ç¤º
        print(f"{'å‚åŠ è€…å':<12} {'å¹³å‡ç‚¹':<8} {'æœ€é«˜ç‚¹':<8} {'æœ€ä½ç‚¹':<8} {'ã‚¹ã‚³ã‚¢æ•°':<8} {'è©•ä¾¡':<8}")
        print("-" * 60)
        
        for participant, stats in sorted_participants:
            avg_score = stats['å¹³å‡ç‚¹']
            if avg_score >= 90:
                evaluation = "å„ªç§€"
            elif avg_score >= 80:
                evaluation = "è‰¯å¥½"
            elif avg_score >= 70:
                evaluation = "æ™®é€š"
            else:
                evaluation = "è¦åŠªåŠ›"
                
            print(f"{participant:<12} {stats['å¹³å‡ç‚¹']:<8} {stats['æœ€é«˜ç‚¹']:<8} {stats['æœ€ä½ç‚¹']:<8} {stats['ã‚¹ã‚³ã‚¢æ•°']:<8} {evaluation:<8}")


def main():
    """ãƒ¡ã‚¤ãƒ³é–¢æ•°"""
    print("ğŸ¯ ã‚¹ã‚³ã‚¢åˆ†æãƒ—ãƒ­ã‚°ãƒ©ãƒ ")
    print("="*50)
    
    # CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’æŒ‡å®š
    csv_file = "sample_scores.csv"  # å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«åã«å¤‰æ›´ã—ã¦ãã ã•ã„
    
    # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã®æ¡ˆå†…
    if not os.path.exists(csv_file):
        print(f"âš ï¸  ãƒ•ã‚¡ã‚¤ãƒ« '{csv_file}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
        print("ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®æ–¹æ³•ã§CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™ã—ã¦ãã ã•ã„ï¼š")
        print("1. å®Ÿéš›ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€ã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¨åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®")
        print("2. ãƒ—ãƒ­ã‚°ãƒ©ãƒ å†…ã® 'csv_file' å¤‰æ•°ã‚’å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«åã«å¤‰æ›´")
        print("3. ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ« 'sample_scores.csv' ã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆ")
        return
    
    # ã‚¹ã‚³ã‚¢åˆ†æå™¨ã‚’ä½œæˆ
    analyzer = ScoreAnalyzer(csv_file)
    
    # ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    if not analyzer.load_csv_data():
        return
    
    # çµ±è¨ˆã‚’è¨ˆç®—
    print("\nğŸ“Š çµ±è¨ˆã‚’è¨ˆç®—ä¸­...")
    statistics_data = analyzer.calculate_statistics()
    
    if not statistics_data:
        print("ã‚¨ãƒ©ãƒ¼: æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
        return
    
    # çµæœã‚’è¡¨ç¤º
    analyzer.display_results(statistics_data)
    
    print(f"\nâœ… åˆ†æå®Œäº†ï¼{len(statistics_data)}åã®å‚åŠ è€…ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã—ã¾ã—ãŸã€‚")


if __name__ == "__main__":
    main()
    